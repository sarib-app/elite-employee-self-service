<style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap');
    
    /* Hide default ERPNext header */
    .navbar, .page-header, .page-head, .web-footer, header {
        display: none !important;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    /* Unified Color System - Light Mode (Default) */
    :root {
        --primary-color: #084887;
        --primary-dark: #063a6b;
        --primary-light: #0a5ba8;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --border-color: #e2e8f0;
        --success-color: #10b981;
        --error-color: #ef4444;
        --warning-color: #f59e0b;
    }
    
    /* Dark Mode */
    [data-theme="dark"] {
        --primary-color: #0d6efd;
        --primary-dark: #084887;
        --primary-light: #3d8bfd;
        --text-primary: #ffffff;
        --text-secondary: #cbd5e1;
        --bg-primary: #1e293b;
        --bg-secondary: #334155;
        --bg-tertiary: #475569;
        --border-color: rgba(148, 163, 184, 0.3);
        --success-color: #10b981;
        --error-color: #ef4444;
        --warning-color: #f59e0b;
    }
    
    body {
        font-family: 'Inter', sans-serif;
        background: var(--bg-secondary);
        min-height: 100vh;
        padding: 0;
        padding-top: 0 !important;
        transition: background 0.3s ease;
    }
    
    body.rtl {
        font-family: 'Cairo', sans-serif;
        direction: rtl;
    }
    
    /* Help Banner */
    .help-banner {
        background: var(--bg-primary);
        padding: 16px 48px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .help-banner-content {
        max-width: 1100px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 16px;
        background: var(--bg-secondary);
        padding: 14px 20px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    
    .help-icon {
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .help-icon i {
        font-size: 18px;
        color: white;
    }
    
    .help-text {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .help-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .help-subtitle {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .help-btn {
        background: var(--primary-color);
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
    }
    
    .help-btn:hover {
        background: var(--primary-dark);
    }
    
    /* Top Header Bar */
    .top-header {
        background: var(--bg-primary);
        padding: 16px 48px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .back-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .back-button:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .page-title-section h1 {
        font-size: 18px;
        color: var(--text-primary);
        font-weight: 600;
    }
    
    .page-title-section p {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 2px;
    }
    
    .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .theme-toggle {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 16px;
        color: var(--text-primary);
    }
    
    .theme-toggle:hover {
        background: var(--bg-tertiary);
        transform: scale(1.05);
    }
    
    .lang-switcher {
        display: flex;
        gap: 4px;
        background: var(--bg-secondary);
        padding: 4px;
        border-radius: 8px;
    }
    
    .lang-btn {
        padding: 6px 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 6px;
        font-weight: 500;
        font-size: 13px;
        color: var(--text-secondary);
        transition: all 0.2s;
    }
    
    .lang-btn.active {
        background: var(--bg-primary);
        color: var(--primary-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }
    
    /* Main Container */
    .form-container {
        max-width: 1100px;
        margin: 16px auto;
        padding: 0 24px;
    }
    
    .form-card {
        background: var(--bg-primary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .form-header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
    }
    
    .form-header h2 {
        font-size: 20px;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 6px;
    }
    
    .form-header p {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }
    
    /* Progress Steps */
    .progress-steps {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 12px;
    }
    
    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        flex: 1;
    }
    
    .step-number {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #e2e8f0;
        color: #94a3b8;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        transition: all 0.3s;
    }
    
    .progress-step.active .step-number {
        background: var(--primary-color);
        color: white;
    }
    
    .progress-step.completed .step-number {
        background: var(--success-color);
        color: white;
    }
    
    .progress-step:not(.active):not(.completed) .step-number {
        background: #e2e8f0;
        color: #94a3b8;
    }
    
    .step-label {
        font-size: 11px;
        color: #94a3b8;
        font-weight: 500;
        text-align: center;
    }
    
    .progress-step.active .step-label {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .progress-step.completed .step-label {
        color: var(--success-color);
        font-weight: 600;
    }
    
    .progress-step:not(.active):not(.completed) .step-label {
        color: #94a3b8;
    }
    
    .progress-line {
        flex: 1;
        height: 2px;
        background: #e2e8f0;
        margin: 0 8px;
        margin-bottom: 30px;
    }
    
    .progress-step.active ~ .progress-line {
        background: var(--primary-color);
    }
    
    /* Step Content Containers */
    .step-content {
        display: none;
    }
    
    .step-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .step-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
        gap: 12px;
    }
    
    .btn-nav {
        padding: 10px 24px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-next {
        background: var(--primary-color);
        color: white;
        margin-left: auto;
    }
    
    .btn-next:hover {
        background: var(--primary-dark);
    }
    
    .btn-back {
        background: var(--bg-primary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }
    
    .btn-back:hover {
        border-color: var(--text-secondary);
        color: var(--text-primary);
    }
    
    .btn-back:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Alert Messages */
    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin: 20px 32px;
        font-size: 13px;
        display: none;
        align-items: center;
        gap: 8px;
    }
    
    .alert.show {
        display: flex;
    }
    
    .alert-success {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: var(--success-color);
    }
    
    [data-theme="dark"] .alert-success {
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: #6ee7b7;
    }
    
    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: var(--error-color);
    }
    
    [data-theme="dark"] .alert-error {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #fca5a5;
    }
    
    /* Form Body */
    .form-body {
        padding: 20px 24px;
    }
    
    .form-section {
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .section-icon {
        color: var(--primary-color);
        font-size: 16px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
    
    .form-grid.single {
        grid-template-columns: 1fr;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .required-mark {
        color: var(--error-color);
    }
    
    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        color: var(--text-primary);
        background: var(--bg-primary);
        transition: all 0.2s;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(8, 72, 135, 0.15);
    }
    
    [data-theme="dark"] .form-input:focus,
    [data-theme="dark"] .form-select:focus,
    [data-theme="dark"] .form-textarea:focus {
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
    }
    
    .form-input:disabled,
    .form-select:disabled {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: not-allowed;
    }
    
    .form-textarea {
        min-height: 80px;
        resize: vertical;
    }
    
    .form-select {
        cursor: pointer;
    }
    
    .input-hint {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 4px;
    }
    
    /* Radio Button for Expense Type */
    .expense-type-radio {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .expense-type-radio:hover {
        border-color: var(--primary-color);
    }
    
    .expense-type-radio input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .expense-type-radio label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        flex: 1;
    }
    
    /* File Upload */
    .file-upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg-secondary);
    }
    
    .file-upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(8, 72, 135, 0.02);
    }
    
    [data-theme="dark"] .file-upload-area:hover {
        background: rgba(13, 110, 253, 0.1);
    }
    
    .file-upload-area i {
        font-size: 32px;
        color: var(--primary-color);
        margin-bottom: 8px;
        display: block;
    }
    
    .file-upload-text {
        font-size: 14px;
        color: var(--text-primary);
        font-weight: 500;
        margin-bottom: 4px;
    }
    
    .file-upload-hint {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .file-input {
        display: none;
    }
    
    .uploaded-files {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .uploaded-file {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: var(--bg-secondary);
        border-radius: 6px;
        font-size: 13px;
        border: 1px solid var(--border-color);
    }
    
    .file-name {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-primary);
    }
    
    .file-name i {
        color: var(--primary-color);
    }
    
    .remove-file {
        background: none;
        border: none;
        color: var(--error-color);
        cursor: pointer;
        padding: 4px;
        font-size: 16px;
        transition: all 0.2s;
    }
    
    .remove-file:hover {
        opacity: 0.7;
    }
    
    /* Card-based Items/Advances Layout */
    .cards-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 16px;
    }
    
    .item-card, .advance-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px 20px;
        position: relative;
        transition: border-color 0.2s;
    }
    
    .item-card:hover, .advance-card:hover {
        border-color: var(--primary-color);
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 14px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--bg-secondary);
    }
    
    .card-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .card-title i {
        color: var(--primary-color);
        font-size: 16px;
    }
    
    .card-number {
        background: var(--primary-color);
        color: white;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
    }
    
    .btn-remove-card {
        background: transparent;
        border: 1px solid #fcc;
        color: var(--error-color);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-remove-card:hover {
        background: var(--error-color);
        color: white;
    }
    
    .card-body {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .card-body .form-group {
        margin-bottom: 0;
    }
    
    .card-body .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .card-body .form-label {
        font-size: 12px;
        margin-bottom: 4px;
    }
    
    .card-body .form-input,
    .card-body .form-select,
    .card-body .form-textarea {
        padding: 8px 12px;
        font-size: 13px;
    }
    
    .card-body .form-textarea {
        min-height: 50px;
    }
    
    .btn-add-card {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        transition: background 0.2s;
    }
    
    .btn-add-card:hover {
        background: var(--primary-dark);
    }
    
    .btn-add-card i {
        font-size: 16px;
    }
    
    /* Amount Badge - Compact */
    .amount-badge {
        background: var(--success-color);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 700;
        text-align: center;
        margin-top: 8px;
        display: inline-block;
    }
    
    .amount-label {
        font-size: 10px;
        font-weight: 500;
        opacity: 0.9;
        display: block;
        margin-bottom: 1px;
    }
    
    /* Searchable Select in Cards */
    .card-body .searchable-select {
        position: relative;
        width: 100%;
    }
    
    .card-body .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 180px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Form Container Shadow */
    .form-container {
        max-width: 1000px;
        margin: 24px auto;
        padding: 0 24px;
    }
    
    .form-card {
        background: var(--bg-primary);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    /* Responsive Cards */
    @media (max-width: 768px) {
        .card-body {
            grid-template-columns: 1fr;
        }
        
        .card-header {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }
        
        .help-banner {
            padding: 12px 20px;
        }
        
        .help-banner-content {
            flex-direction: column;
            text-align: center;
        }
        
        .progress-steps {
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .progress-line {
            display: none;
        }
        
        .progress-step {
            flex: 0 0 45%;
        }
    }
    .items-table-container {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: visible;
        margin-top: 16px;
        background: var(--bg-primary);
    }
    
    .items-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .items-table thead {
        background: var(--bg-secondary);
    }
    
    .items-table th {
        padding: 14px 12px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 2px solid var(--border-color);
    }
    
    .items-table td {
        padding: 12px 8px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }
    
    .items-table tbody tr:hover {
        background: #fafbfc;
    }
    
    .items-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .items-table input,
    .items-table select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .items-table input:focus,
    .items-table select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(8, 72, 135, 0.15);
    }
    
    [data-theme="dark"] .items-table input:focus,
    [data-theme="dark"] .items-table select:focus {
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
    }
    
    .items-table input[readonly] {
        background: var(--bg-secondary);
        cursor: not-allowed;
        font-weight: 600;
        color: var(--primary-color);
    }
    
    /* Searchable Select Dropdown */
    .searchable-select {
        position: relative;
        width: 100%;
    }
    
    .searchable-select input[type="text"] {
        width: 100%;
    }
    
    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item:hover {
        background: var(--bg-secondary);
    }
    
    .dropdown-item strong {
        color: var(--text-primary);
        font-size: 14px;
    }
    
    .dropdown-item small {
        color: var(--text-secondary);
        font-size: 12px;
    }
    
    .table-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-add {
        background: var(--primary-color);
        color: white;
        margin-top: 12px;
    }
    
    .btn-add:hover {
        background: var(--primary-dark);
    }
    
    .btn-remove {
        background: transparent;
        color: var(--error-color);
        padding: 4px 8px;
    }
    
    .btn-remove:hover {
        background: #fef2f2;
    }
    
    /* Total Amount Display */
    .total-amount-display {
        background: var(--bg-secondary);
        padding: 16px 20px;
        border-radius: 8px;
        margin-top: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid var(--border-color);
    }
    
    .total-label {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .total-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    /* Form Footer */
    .form-footer {
        padding: 24px 32px;
        border-top: 1px solid var(--border-color);
        background: var(--bg-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
    }
    
    .button-group {
        display: flex;
        gap: 12px;
    }
    
    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
    }
    
    .btn-primary:disabled {
        background: #94a3b8;
        cursor: not-allowed;
    }
    
    .btn-secondary {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
        border-color: var(--text-secondary);
    }
    
    .btn.loading {
        position: relative;
        color: transparent;
    }
    
    .btn.loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: background 0.3s ease;
    }
    
    [data-theme="dark"] .loading-overlay {
        background: rgba(30, 41, 59, 0.95);
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    .hidden {
        display: none;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .top-header {
            flex-direction: column;
            gap: 16px;
            padding: 16px 20px;
        }
    
        .form-container {
            padding: 0 16px;
            margin: 16px auto;
        }
    
        .form-grid {
            grid-template-columns: 1fr;
        }
    
        .form-body,
        .form-header,
        .form-footer {
            padding: 20px;
        }
    
        .form-footer {
            flex-direction: column;
        }
    
        .button-group {
            width: 100%;
            flex-direction: column;
        }
    
        .btn {
            width: 100%;
            justify-content: center;
        }
    
        .items-table-container {
            overflow-x: auto;
        }
    }
    
    /* RTL Support */
    body.rtl .back-button {
        flex-direction: row-reverse;
    }
    
    body.rtl .form-label {
        flex-direction: row-reverse;
    }
    
    body.rtl .btn {
        flex-direction: row-reverse;
    }
    
    body.rtl .items-table th {
        text-align: right;
    }
    </style>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Top Header -->
        <div class="top-header">
            <div class="header-left">
                <a href="/employee-portal-home" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                    <span data-en="Back to Dashboard" data-ar="العودة إلى لوحة التحكم">Back to Dashboard</span>
                </a>
                <div class="page-title-section">
                    <h1 data-en="Submit New Request" data-ar="تقديم طلب جديد">Submit New Request</h1>
                    <p data-en="Create a new Request for Payment" data-ar="إنشاء طلب دفع جديد">Create a new Request for Payment</p>
                </div>
            </div>
            
            <div class="header-right">
                <button class="theme-toggle" id="themeToggle" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <div class="lang-switcher">
                    <button class="lang-btn active">English</button>
                    <button class="lang-btn">العربية</button>
                </div>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">--</div>
                </div>
            </div>
        </div>
    
        <!-- Help Banner -->
        <div class="help-banner">
            <div class="help-banner-content">
                <div class="help-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="help-text">
                    <span class="help-title" data-en="Need help with submitting form?" data-ar="هل تحتاج مساعدة في تقديم النموذج؟">Need help with submitting form?</span>
                    <span class="help-subtitle" data-en="Watch out this tutorial to learn how to submit your requests step by step" data-ar="شاهد هذا البرنامج التعليمي لتعلم كيفية تقديم طلباتك خطوة بخطوة">Watch out this tutorial to learn how to submit your requests step by step</span>
                </div>
                <a href="#" class="help-btn" onclick="alert('Tutorial video will be added here'); return false;">
                    <i class="fas fa-play-circle"></i>
                    <span data-en="Watch Tutorial" data-ar="شاهد البرنامج التعليمي">Watch Tutorial</span>
                </a>
            </div>
        </div>
    
        <!-- Form Container -->
        <div class="form-container">
            <form id="requestForm" class="form-card">
                <!-- Form Header -->
                <div class="form-header">
                    <h2 data-en="Request Details" data-ar="تفاصيل الطلب">Request Details</h2>
                    <p data-en="Fill in the information below to submit your request" data-ar="املأ المعلومات أدناه لتقديم طلبك">Fill in the information below to submit your request</p>
                    
                    <!-- Progress Steps -->
                    <div class="progress-steps">
                        <div class="progress-step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-label" data-en="Employee Data" data-ar="بيانات الموظف">Employee Data</div>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-label" data-en="Request Type" data-ar="نوع الطلب">Request Type</div>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-label" data-en="Request Form" data-ar="نموذج الطلب">Request Form</div>
                        </div>
                        <div class="progress-line"></div>
                        <div class="progress-step" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-label" data-en="Documents" data-ar="المستندات">Documents</div>
                        </div>
                    </div>
                </div>
    
                <!-- Alert Message -->
                <div id="alertMessage" class="alert"></div>
    
                <!-- Form Body -->
                <div class="form-body">
                    <!-- Step 1: Employee Data -->
                    <div class="step-content active" id="step1">
                        <!-- Employee Information (Auto-filled, Read-only) -->
                        <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-user section-icon"></i>
                            <span data-en="Employee Information" data-ar="معلومات الموظف">Employee Information</span>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" data-en="Employee Name" data-ar="اسم الموظف">Employee Name</label>
                                <input type="text" class="form-input" id="employeeName" value="Loading..." disabled />
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-en="Employee Number" data-ar="رقم الموظف">Employee Number</label>
                                <input type="text" class="form-input" id="employeeNo" value="Loading..." disabled />
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-en="Iqama Number" data-ar="رقم الإقامة">Iqama Number</label>
                                <input type="text" class="form-input" id="iqamaNo" value="Loading..." disabled />
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-en="Request Date" data-ar="تاريخ الطلب">Request Date</label>
                                <input type="date" class="form-input" id="requestDate" disabled />
                            </div>
                        </div>
                    </div>
                    </div>
    
                    <!-- Step 2: Request Type -->
                    <div class="step-content" id="step2">
                        <!-- Expense Type Selection -->
                        <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-receipt section-icon"></i>
                            <span data-en="Expense Type" data-ar="نوع النفقات">Expense Type</span>
                        </div>
                        <div class="expense-type-radio">
                            <input type="checkbox" id="isAdvance" />
                            <label for="isAdvance" data-en="Deduct from salary (Loan/Advance)" data-ar="خصم من الراتب (قرض/سلفة)">Deduct from salary (Loan/Advance)</label>
                        </div>
                        <input type="hidden" id="expenseType" value="Operational Expense" />
                        </div>
                    </div>
    
                    <!-- Step 3: Request Form -->
                    <div class="step-content" id="step3">
                        <!-- Items Section (Operational Expense) -->
                        <div class="form-section" id="itemsSection">
                        <div class="section-title">
                            <i class="fas fa-list-ul section-icon"></i>
                            <span data-en="Items" data-ar="العناصر">Items</span>
                        </div>
                        
                        <div id="itemsCardsContainer" class="cards-container">
                            <!-- Item cards will be added here -->
                        </div>
                        
                        <button type="button" class="btn-add-card" onclick="addItemCard()">
                            <i class="fas fa-plus-circle"></i>
                            <span data-en="Add Item" data-ar="إضافة عنصر">Add Item</span>
                        </button>
                    </div>
    
                    <!-- Advances Section (Employee Advance) -->
                    <div class="form-section hidden" id="advancesSection">
                        <div class="section-title">
                            <i class="fas fa-hand-holding-usd section-icon"></i>
                            <span data-en="Advance Details" data-ar="تفاصيل السلفة">Advance Details</span>
                        </div>
                        
                        <div id="advancesCardsContainer" class="cards-container">
                            <!-- Advance cards will be added here -->
                        </div>
                        
                        <button type="button" class="btn-add-card" onclick="addAdvanceCard()">
                            <i class="fas fa-plus-circle"></i>
                            <span data-en="Add Advance" data-ar="إضافة سلفة">Add Advance</span>
                        </button>
                        </div>
                    </div>
    
                    <!-- Step 4: Documents -->
                    <div class="step-content" id="step4">
                        <!-- Attach Documents -->
                        <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-paperclip section-icon"></i>
                            <span data-en="Attach Documents" data-ar="إرفاق المستندات">Attach Documents</span>
                            <span class="required-mark">*</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <span data-en="Attach any approval or related documents below" data-ar="إرفاق أي موافقات أو مستندات ذات صلة أدناه">Attach any approval or related documents below</span>
                                <span class="required-mark">*</span>
                            </label>
                            <div class="file-upload-area" onclick="document.getElementById('attachments').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <div class="file-upload-text" data-en="Click to upload documents (Required)" data-ar="انقر لتحميل المستندات (مطلوب)">Click to upload documents (Required)</div>
                                <div class="file-upload-hint" data-en="PDF, JPG, PNG, Excel - You can upload multiple files" data-ar="PDF، JPG، PNG، Excel - يمكنك تحميل ملفات متعددة">PDF, JPG, PNG, Excel - You can upload multiple files</div>
                            </div>
                            <input type="file" id="attachments" class="file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.doc,.docx" required />
                            <div id="uploadedAttachments" class="uploaded-files"></div>
                        </div>
                        </div>
                    </div>
                </div>
    
                <!-- Step Navigation -->
                <div class="step-navigation">
                    <button type="button" class="btn-nav btn-back" id="btnBack" onclick="previousStep()" disabled>
                        <i class="fas fa-arrow-left"></i>
                        <span data-en="Back" data-ar="السابق">Back</span>
                    </button>
                    <div style="flex: 1;"></div>
                    <button type="button" class="btn-nav btn-next" id="btnNext" onclick="nextStep()">
                        <span data-en="Next" data-ar="التالي">Next</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <button type="button" class="btn-nav btn-next" id="submitBtn" style="display: none;" onclick="if(validateCurrentStep()) { submitRequest(); }">
                        <span data-en="Submit Request" data-ar="تقديم الطلب">Submit Request</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
    // Theme Toggle Functionality
    (function() {
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const html = document.documentElement;
        
        // Get saved theme or default to light
        const savedTheme = localStorage.getItem('employeePortalTheme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
        
        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
        }
        
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('employeePortalTheme', newTheme);
                updateThemeIcon(newTheme);
            });
        }
    })();

    let currentLang = localStorage.getItem('employeePortalLang') || 'en';
    let currentUser = null;
    let employeeData = null;
    let itemsList = [];
    let loanTypesList = [];
    let uploadedFiles = [];  // Array to store multiple files
    let currentStep = 1;
    const totalSteps = 4;
    
    // Step Navigation Functions
    function showStep(step) {
        // Hide all steps and remove required from hidden fields
        for (let i = 1; i <= totalSteps; i++) {
            const stepContent = document.getElementById('step' + i);
            const stepIndicator = document.querySelector('[data-step="' + i + '"]');
            if (stepContent) {
                stepContent.classList.remove('active');
                // Remove required from all fields in hidden steps
                const requiredFields = stepContent.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    field.removeAttribute('required');
                    field.setAttribute('data-was-required', 'true');
                });
            }
            if (stepIndicator) {
                stepIndicator.classList.remove('active');
                if (i < step) {
                    stepIndicator.classList.add('completed');
                } else {
                    stepIndicator.classList.remove('completed');
                }
            }
        }
        
        // Show current step and restore required attributes
        const currentStepContent = document.getElementById('step' + step);
        const currentStepIndicator = document.querySelector('[data-step="' + step + '"]');
        if (currentStepContent) {
            currentStepContent.classList.add('active');
            // Restore required attributes for active step
            const fieldsToRequire = currentStepContent.querySelectorAll('[data-was-required="true"]');
            fieldsToRequire.forEach(field => {
                field.setAttribute('required', 'required');
            });
        }
        if (currentStepIndicator) currentStepIndicator.classList.add('active');
        
        // Update navigation buttons
        const btnBack = document.getElementById('btnBack');
        const btnNext = document.getElementById('btnNext');
        const btnSubmit = document.getElementById('submitBtn');
        
        if (btnBack) {
            btnBack.disabled = (step === 1);
        }
        
        if (btnNext && btnSubmit) {
            if (step === totalSteps) {
                btnNext.style.display = 'none';
                btnSubmit.style.display = 'inline-flex';
            } else {
                btnNext.style.display = 'inline-flex';
                btnSubmit.style.display = 'none';
            }
        }
        
        currentStep = step;
    }
    
    function nextStep() {
        if (validateCurrentStep()) {
            if (currentStep < totalSteps) {
                showStep(currentStep + 1);
            }
        }
    }
    
    function previousStep() {
        if (currentStep > 1) {
            showStep(currentStep - 1);
        }
    }
    
    function validateCurrentStep() {
        const stepContent = document.getElementById('step' + currentStep);
        if (!stepContent) return true;
        
        // Check HTML5 validation for visible fields in current step
        const form = document.getElementById('requestForm');
        const stepFields = stepContent.querySelectorAll('input, select, textarea');
        let firstInvalid = null;
        
        for (let field of stepFields) {
            if (field.hasAttribute('required') || field.hasAttribute('data-was-required')) {
                if (!field.value || (field.type === 'number' && parseFloat(field.value) <= 0)) {
                    if (!firstInvalid) firstInvalid = field;
                    field.setAttribute('required', 'required');
                }
            }
        }
        
        // Step 1: Employee Data - always valid (read-only)
        if (currentStep === 1) return true;
        
        // Step 2: Request Type - always valid
        if (currentStep === 2) return true;
        
        // Step 3: Request Form - validate items or advances
        if (currentStep === 3) {
            const isAdvance = document.getElementById('isAdvance').checked;
            if (isAdvance) {
                const advanceCards = document.querySelectorAll('.advance-card');
                if (advanceCards.length === 0) {
                    showAlert('error', currentLang === 'ar' ? 'يرجى إضافة سلفة واحدة على الأقل' : 'Please add at least one advance');
                    return false;
                }
                for (let card of advanceCards) {
                    const advanceType = card.querySelector('.advance-type')?.value;
                    const advanceAmount = card.querySelector('.advance-amount')?.value;
                    const advanceSearch = card.querySelector('.advance-search')?.value;
                    if (!advanceType || !advanceSearch || !advanceAmount || parseFloat(advanceAmount) <= 0) {
                        showAlert('error', currentLang === 'ar' ? 'يرجى ملء جميع حقول السلفة' : 'Please fill all advance fields');
                        if (firstInvalid) firstInvalid.focus();
                        return false;
                    }
                }
            } else {
                const itemCards = document.querySelectorAll('.item-card');
                if (itemCards.length === 0) {
                    showAlert('error', currentLang === 'ar' ? 'يرجى إضافة عنصر واحد على الأقل' : 'Please add at least one item');
                    return false;
                }
                for (let card of itemCards) {
                    const itemSelect = card.querySelector('.item-select')?.value;
                    const itemSearch = card.querySelector('.item-search')?.value;
                    const qty = card.querySelector('.qty')?.value;
                    const rate = card.querySelector('.rate')?.value;
                    if (!itemSelect || !itemSearch || !qty || !rate || parseFloat(qty) <= 0 || parseFloat(rate) <= 0) {
                        showAlert('error', currentLang === 'ar' ? 'يرجى ملء جميع حقول العنصر' : 'Please fill all item fields');
                        if (firstInvalid) firstInvalid.focus();
                        return false;
                    }
                }
            }
            return true;
        }
        
        // Step 4: Documents - validate attachments
        if (currentStep === 4) {
            if (uploadedFiles.length === 0) {
                const uploadArea = document.getElementById('fileUploadArea');
                if (uploadArea) {
                    uploadArea.classList.add('required');
                    uploadArea.style.borderColor = 'var(--error-color)';
                    uploadArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                showAlert('error', currentLang === 'ar' ? 'إرفاق المستندات إلزامي! يرجى إرفاق مستند واحد على الأقل' : 'Attachments are mandatory! Please attach at least one document');
                return false;
            }
            return true;
        }
        
        // If we have an invalid field, focus it
        if (firstInvalid) {
            firstInvalid.focus();
            firstInvalid.reportValidity();
            return false;
        }
        
        return true;
    }
    
    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkAuthentication();
        setTodayDate();
        loadItems();
        loadLoanTypes();
        
        // Setup file upload for multiple files
        setupFileUpload();
        
        // Add first item card by default
        setTimeout(() => {
            addItemCard();
            // Initialize step navigation
            showStep(1);
        }, 500);
    });
    
    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('requestDate').value = today;
    }
    
    function setupFileUpload() {
        document.getElementById('attachments').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    showAlert('error', `File ${file.name} is too large. Maximum size is 10MB`);
                    return;
                }
                uploadedFiles.push(file);
            });
            
            displayUploadedFiles();
        });
    }
    
    function displayUploadedFiles() {
        const container = document.getElementById('uploadedAttachments');
        container.innerHTML = '';
        
        uploadedFiles.forEach((file, index) => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'uploaded-file';
            fileDiv.innerHTML = `
                <div class="file-name">
                    <i class="fas fa-file"></i>
                    <span>${file.name}</span>
                </div>
                <button type="button" class="remove-file" onclick="removeUploadedFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(fileDiv);
        });
    }
    
    function removeUploadedFile(index) {
        uploadedFiles.splice(index, 1);
        displayUploadedFiles();
        
        // Reset file input
        document.getElementById('attachments').value = '';
    }
    
    function loadItems() {
        frappe.call({
            method: 'frappe.client.get_list',
            args: {
                doctype: 'Item',
                fields: ['name', 'item_name'],
                limit_page_length: 9999
            },
            callback: function(r) {
                if (r.message) {
                    itemsList = r.message;
                    console.log('Loaded items:', itemsList.length);
                }
            }
        });
    }
    
    function loadLoanTypes() {
        frappe.call({
            method: 'frappe.client.get_list',
            args: {
                doctype: 'Loan Type',
                fields: ['name'],
                limit_page_length: 9999
            },
            callback: function(r) {
                if (r.message) {
                    loanTypesList = r.message;
                    console.log('Loaded loan types:', loanTypesList.length);
                }
            }
        });
    }
    
    function checkAuthentication() {
        frappe.call({
            method: 'frappe.auth.get_logged_user',
            callback: function(r) {
                if (r.message && r.message !== 'Guest') {
                    currentUser = r.message;
                    console.log('Logged in user:', currentUser);
                    loadEmployeeData();
                } else {
                    window.location.href = '/employee-login';
                }
            },
            error: function() {
                window.location.href = '/employee-login';
            }
        });
    }
    
    function loadEmployeeData() {
        frappe.call({
            method: 'frappe.client.get_list',
            args: {
                doctype: 'Employee',
                filters: {
                    user_id: currentUser
                },
                fields: ['name']
            },
            callback: function(r) {
                if (r.message && r.message.length > 0) {
                    console.log('Employee found:', r.message[0].name);
                    fetchFullEmployeeDetails(r.message[0].name);
                } else {
                    console.log('No employee record found, using default values');
                    employeeData = {
                        employee_name: currentUser.split('@')[0] || 'User',
                        employee: '',  // Empty employee number
                        iqama_national_id: ''
                    };
                    populateEmployeeFields();
                    initializePage();
                }
            },
            error: function(err) {
                console.error('Employee lookup error:', err);
                employeeData = {
                    employee_name: currentUser.split('@')[0] || 'User',
                    employee: '',
                    iqama_national_id: ''
                };
                populateEmployeeFields();
                initializePage();
            }
        });
    }
    
    function fetchFullEmployeeDetails(employeeName) {
        frappe.call({
            method: 'frappe.client.get',
            args: {
                doctype: 'Employee',
                name: employeeName
            },
            callback: function(r) {
                if (r.message) {
                    employeeData = r.message;
                    console.log('Full employee data received:', employeeData);
                    console.log('Employee field value:', employeeData.employee);
                    console.log('Employee name field value:', employeeData.employee_name);
                    console.log('All fields:', Object.keys(employeeData));
                    populateEmployeeFields();
                    initializePage();
                }
            },
            error: function() {
                populateEmployeeFields();
                initializePage();
            }
        });
    }
    
    function populateEmployeeFields() {
        document.getElementById('employeeName').value = employeeData?.employee_name || '';
        document.getElementById('employeeNo').value = employeeData?.name || '';  // Use 'name' - this is the actual Employee ID (HR-EMP-01129)
        
        const iqama = employeeData?.iqama_national_id || '';
        document.getElementById('iqamaNo').value = iqama;
        
        const nameParts = (employeeData?.employee_name || '').split(' ');
        const initials = nameParts.length >= 2 
            ? (nameParts[0][0] + nameParts[1][0]).toUpperCase()
            : (employeeData?.employee_name || 'U').substring(0, 2).toUpperCase();
        document.getElementById('userAvatar').textContent = initials;
        
        console.log('Employee populated:', {
            name: employeeData?.name,  // This is the Employee ID
            employee_name: employeeData?.employee_name,
            iqama_national_id: employeeData?.iqama_national_id
        });
    }
    
    function initializePage() {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        applyLanguage(currentLang);
    }
    
    // Expense Type Toggle
    document.getElementById('isAdvance').addEventListener('change', function() {
        const isAdvance = this.checked;
        const expenseType = isAdvance ? 'Employee Advance' : 'Operational Expense';
        document.getElementById('expenseType').value = expenseType;
        
        if (isAdvance) {
            document.getElementById('itemsSection').classList.add('hidden');
            document.getElementById('advancesSection').classList.remove('hidden');
            
            if (document.getElementById('advancesCardsContainer').children.length === 0) {
                addAdvanceCard();
            }
        } else {
            document.getElementById('itemsSection').classList.remove('hidden');
            document.getElementById('advancesSection').classList.add('hidden');
            
            if (document.getElementById('itemsCardsContainer').children.length === 0) {
                addItemCard();
            }
        }
    });
    
    // Items Card Functions
    let itemCardCounter = 0;
    
    function addItemCard() {
        itemCardCounter++;
        const container = document.getElementById('itemsCardsContainer');
        const card = document.createElement('div');
        card.className = 'item-card';
        card.id = 'item-card-' + itemCardCounter;
        
        card.innerHTML = `
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-box"></i>
                    <span data-en="Item" data-ar="عنصر">Item</span>
                    <span class="card-number">#${itemCardCounter}</span>
                </div>
                <button type="button" class="btn-remove-card" onclick="removeCard('item-card-${itemCardCounter}')">
                    <i class="fas fa-trash-alt"></i>
                    <span data-en="Remove" data-ar="حذف">Remove</span>
                </button>
            </div>
            <div class="card-body">
                <div class="form-group full-width">
                    <label class="form-label">
                        <span data-en="Search & Select Item" data-ar="ابحث واختر العنصر">Search & Select Item</span>
                        <span class="required-mark">*</span>
                    </label>
                    <div class="searchable-select">
                        <input type="text" class="form-input item-search" placeholder="Type to search items..." onkeyup="searchItems(this)" onfocus="showItemDropdown(this)" required />
                        <div class="dropdown-list" style="display: none;"></div>
                        <input type="hidden" class="item-select" />
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label" data-en="Item Name" data-ar="اسم العنصر">Item Name</label>
                    <input type="text" class="form-input item-name" readonly style="background: #f8fafc; font-weight: 500;" />
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span data-en="Quantity" data-ar="الكمية">Quantity</span>
                        <span class="required-mark">*</span>
                    </label>
                    <input type="number" class="form-input qty" value="1" min="1" step="1" onchange="calculateCardAmount(this)" required />
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span data-en="Rate (SAR)" data-ar="السعر (ريال)">Rate (SAR)</span>
                        <span class="required-mark">*</span>
                    </label>
                    <input type="number" class="form-input rate" placeholder="0.00" step="0.01" min="0" onchange="calculateCardAmount(this)" required />
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label" data-en="Remarks / Notes" data-ar="ملاحظات / ملاحظات">Remarks / Notes</label>
                    <textarea class="form-textarea remarks" rows="2" placeholder="Add any additional notes here..."></textarea>
                </div>
                
                <div class="form-group full-width">
                    <div class="amount-badge">
                        <span class="amount-label" data-en="Total Amount" data-ar="المبلغ الإجمالي">Total Amount</span>
                        <span class="amount-value">0.00 SAR</span>
                    </div>
                    <input type="hidden" class="amount" value="0" />
                </div>
            </div>
        `;
        
        container.appendChild(card);
        applyLanguage(currentLang);
    }
    
    function searchItems(input) {
        const searchTerm = input.value.toLowerCase();
        const dropdown = input.nextElementSibling;
        
        dropdown.innerHTML = '';
        
        const filtered = itemsList.filter(item => 
            item.item_name.toLowerCase().includes(searchTerm) || 
            item.name.toLowerCase().includes(searchTerm)
        );
        
        if (filtered.length > 0) {
            filtered.slice(0, 10).forEach(item => {
                const option = document.createElement('div');
                option.className = 'dropdown-item';
                option.innerHTML = `<strong>${item.item_name}</strong><br><small style="color: var(--text-secondary);">${item.name}</small>`;
                option.onclick = function() {
                    selectItem(input, item);
                };
                dropdown.appendChild(option);
            });
            dropdown.style.display = 'block';
        } else {
            dropdown.style.display = 'none';
        }
    }
    
    function showItemDropdown(input) {
        searchItems(input);
    }
    
    function selectItem(input, item) {
        const card = input.closest('.item-card');
        input.value = item.item_name;
        card.querySelector('.item-select').value = item.name;
        card.querySelector('.item-name').value = item.item_name;
        input.nextElementSibling.style.display = 'none';
    }
    
    // Advances Card Functions
    let advanceCardCounter = 0;
    
    function addAdvanceCard() {
        advanceCardCounter++;
        const container = document.getElementById('advancesCardsContainer');
        const card = document.createElement('div');
        card.className = 'advance-card';
        card.id = 'advance-card-' + advanceCardCounter;
        
        card.innerHTML = `
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span data-en="Advance" data-ar="سلفة">Advance</span>
                    <span class="card-number">#${advanceCardCounter}</span>
                </div>
                <button type="button" class="btn-remove-card" onclick="removeCard('advance-card-${advanceCardCounter}')">
                    <i class="fas fa-trash-alt"></i>
                    <span data-en="Remove" data-ar="حذف">Remove</span>
                </button>
            </div>
            <div class="card-body">
                <div class="form-group full-width">
                    <label class="form-label">
                        <span data-en="Search & Select Advance Type" data-ar="ابحث واختر نوع السلفة">Search & Select Advance Type</span>
                        <span class="required-mark">*</span>
                    </label>
                    <div class="searchable-select">
                        <input type="text" class="form-input advance-search" placeholder="Type to search advance types..." onkeyup="searchAdvanceTypes(this)" onfocus="showAdvanceDropdown(this)" required />
                        <div class="dropdown-list" style="display: none;"></div>
                        <input type="hidden" class="advance-type" />
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span data-en="Advance Amount (SAR)" data-ar="مبلغ السلفة (ريال)">Advance Amount (SAR)</span>
                        <span class="required-mark">*</span>
                    </label>
                    <input type="number" class="form-input advance-amount" placeholder="0.00" step="0.01" min="0" required />
                </div>
                
                <div class="form-group">
                    <label class="form-label" data-en="Monthly Repayment (SAR)" data-ar="الدفع الشهري (ريال)">Monthly Repayment (SAR)</label>
                    <input type="number" class="form-input monthly-repay" placeholder="0.00" step="0.01" min="0" />
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label" data-en="Repayment Start Date" data-ar="تاريخ بداية السداد">Repayment Start Date</label>
                    <input type="date" class="form-input repayment-start" />
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label" data-en="Remarks / Notes" data-ar="ملاحظات / ملاحظات">Remarks / Notes</label>
                    <textarea class="form-textarea adv-remarks" rows="2" placeholder="Add any additional notes here..."></textarea>
                </div>
            </div>
        `;
        
        container.appendChild(card);
        applyLanguage(currentLang);
    }
    
    function searchAdvanceTypes(input) {
        const searchTerm = input.value.toLowerCase();
        const dropdown = input.nextElementSibling;
        
        dropdown.innerHTML = '';
        
        const filtered = loanTypesList.filter(loan => 
            loan.name.toLowerCase().includes(searchTerm)
        );
        
        if (filtered.length > 0) {
            filtered.slice(0, 10).forEach(loan => {
                const option = document.createElement('div');
                option.className = 'dropdown-item';
                option.textContent = loan.name;
                option.onclick = function() {
                    selectAdvanceType(input, loan);
                };
                dropdown.appendChild(option);
            });
            dropdown.style.display = 'block';
        } else {
            dropdown.style.display = 'none';
        }
    }
    
    function showAdvanceDropdown(input) {
        searchAdvanceTypes(input);
    }
    
    function selectAdvanceType(input, loan) {
        const card = input.closest('.advance-card');
        input.value = loan.name;
        card.querySelector('.advance-type').value = loan.name;
        input.nextElementSibling.style.display = 'none';
    }
    
    function removeCard(cardId) {
        const card = document.getElementById(cardId);
        if (card) {
            card.style.transform = 'scale(0.8)';
            card.style.opacity = '0';
            setTimeout(() => {
                card.remove();
            }, 300);
        }
    }
    
    function calculateCardAmount(input) {
        const card = input.closest('.item-card');
        const qty = parseFloat(card.querySelector('.qty').value) || 0;
        const rate = parseFloat(card.querySelector('.rate').value) || 0;
        const amount = qty * rate;
        
        card.querySelector('.amount').value = amount.toFixed(2);
        card.querySelector('.amount-value').textContent = amount.toFixed(2) + ' SAR';
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('item-search') && !e.target.classList.contains('advance-search')) {
            document.querySelectorAll('.dropdown-list').forEach(d => d.style.display = 'none');
        }
    });
    
    // Language Switcher
    document.querySelectorAll('.lang-btn').forEach(button => {
        button.addEventListener('click', function() {
            const lang = this.textContent.includes('English') ? 'en' : 'ar';
            currentLang = lang;
            localStorage.setItem('employeePortalLang', lang);
            
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            applyLanguage(lang);
        });
    });
    
    function applyLanguage(lang) {
        const body = document.body;
        const html = document.documentElement;
        
        if (lang === 'ar') {
            body.classList.add('rtl');
            html.setAttribute('dir', 'rtl');
        } else {
            body.classList.remove('rtl');
            html.setAttribute('dir', 'ltr');
        }
        html.setAttribute('lang', lang);
        
        document.querySelectorAll('[data-' + lang + ']').forEach(element => {
            const text = element.getAttribute('data-' + lang);
            element.textContent = text;
        });
    }
    
    // Form Submission
    document.getElementById('requestForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitRequest();
    });
    
    async function submitRequest() {
        const submitBtn = document.getElementById('submitBtn');
        
        // Validate attachments
        if (uploadedFiles.length === 0) {
            showAlert('error', 
                currentLang === 'ar'
                    ? '❌ يرجى إرفاق مستند واحد على الأقل'
                    : '❌ Please attach at least one document'
            );
            return;
        }
        
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
        }
        
        const isAdvance = document.getElementById('isAdvance').checked;
        const expenseType = document.getElementById('expenseType').value;
        
        const iqama = employeeData?.iqama_national_id || '';
        const employeeNo = employeeData?.name || '';  // Use 'name' field - this is the Employee DocType ID
        
        // Prepare base document with correct field names from DocType
        const formData = {
            doctype: 'Request For Payment',  // Note: "For" with capital F
            naming_series: 'RFP-.YY.-',
            expense_type: expenseType,
            date: document.getElementById('requestDate').value,  // Use 'date' not 'request_date'
            project: 'PROJ-0022',
            project_name: 'Riyadh Schools Platform',
            company: 'Elite Resources Center',
            invoice_to_client: 'No',
            verified: 'False',  // Set verified to False when submitted from employee portal
            total_amount: 0  // Will be calculated from items/advances
        };
        
        if (isAdvance) {
            const advances = [];
            document.querySelectorAll('.advance-card').forEach(card => {
                const advanceAmount = parseFloat(card.querySelector('.advance-amount').value) || 0;
                formData.total_amount += advanceAmount;
                
                advances.push({
                    employee_no: employeeNo,
                    employee_name: employeeData?.employee_name || '',
                    iqama: iqama,
                    advance_type: card.querySelector('.advance-type').value,
                    advance_amount: advanceAmount,
                    monthly_repay_amount: parseFloat(card.querySelector('.monthly-repay').value) || 0,
                    repayment_start_date: card.querySelector('.repayment-start').value,
                    remarks: card.querySelector('.adv-remarks').value
                });
            });
            formData.advances = advances;
        } else {
            const items = [];
            document.querySelectorAll('.item-card').forEach(card => {
                const amount = parseFloat(card.querySelector('.amount').value) || 0;
                formData.total_amount += amount;
                
                items.push({
                    employee_no: employeeNo,
                    employee_name: employeeData?.employee_name || '',
                    iqama: iqama,
                    item: card.querySelector('.item-select').value,
                    item_name: card.querySelector('.item-name').value,
                    sadad_no: '',
                    qty: parseFloat(card.querySelector('.qty').value) || 1,
                    rate: parseFloat(card.querySelector('.rate').value) || 0,
                    amount: amount,
                    remarks: card.querySelector('.remarks').value
                });
            });
            formData.items = items;
        }
        
        console.log('Submitting data:', formData);
        
        // Create RFP document using frappe.new_doc
        frappe.call({
            method: 'frappe.client.insert',
            args: {
                doc: formData
            },
            callback: async function(r) {
                if (r.message) {
                    console.log('Success response:', r.message);
                    const rfpName = r.message.name;
                    
                    // Upload attachments if any
                    if (uploadedFiles.length > 0) {
                        await uploadAttachments(rfpName);
                    }
                    
                    showAlert('success', 
                        currentLang === 'ar' 
                            ? `✅ تم إنشاء الطلب بنجاح! رقم الطلب: ${rfpName}`
                            : `✅ Request created successfully! Request ID: ${rfpName}`
                    );
                    
                    setTimeout(function() {
                        window.location.href = '/employee-portal-home';
                    }, 2000);
                }
            },
            error: function(r) {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('loading');
                }
                console.error('Submission error:', r);
                
                // Show detailed error
                let errorMsg = 'Failed to create request. ';
                if (r.exc) {
                    const excLines = r.exc.split('\n');
                    const errorLine = excLines.find(line => line.includes('Error:') || line.includes('Exception:'));
                    if (errorLine) {
                        errorMsg += errorLine;
                    }
                }
                
                showAlert('error', 
                    currentLang === 'ar'
                        ? '❌ فشل في إنشاء الطلب. يرجى المحاولة مرة أخرى'
                        : '❌ ' + errorMsg
                );
            }
        });
    }
    
    async function uploadAttachments(rfpName) {
        for (const file of uploadedFiles) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('doctype', 'Request For Payment');
                formData.append('docname', rfpName);
                formData.append('is_private', 0);
                
                await fetch('/api/method/upload_file', {
                    method: 'POST',
                    body: formData
                });
            } catch (e) {
                console.error('File upload error:', e);
            }
        }
    }
    
    function showAlert(type, message) {
        const alert = document.getElementById('alertMessage');
        alert.className = `alert alert-${type} show`;
        alert.innerHTML = message;
        
        setTimeout(() => {
            alert.classList.remove('show');
        }, 5000);
    }
    </script>